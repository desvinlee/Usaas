<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Assistant Order</title>
    <link rel="stylesheet" href="assets/css/css/sb-admin-2.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
</head>

<body id="page-top">
    <div id="wrapper">

        <!--sidebar copy start from here the whole ul class-->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <hr class="sidebar-divider my-0">

            <div class="sidebar-heading">
                <img width="100" height="80" src="assets/img/Homepage/usaas_logo.svg" />
            </div>

            <li class="nav-item active">
                <a class="nav-link" href="Assistant_Dashboard.html">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Assistant Dashboard</span></a>
            </li>


            <hr class="sidebar-divider">


            <div class="sidebar-heading">
                Interface
            </div>


            <li class="nav-item">
                <a class="nav-link collapsed" href="Assistant_Orderlist.html" data-target="#collapseTwo"
                    aria-expanded="true" aria-controls="collapseTwo">
                    <i class="fas fa-fw fa-chart-area"></i>
                    <span>Order List</span>
                </a>
            </li>


            <li class="nav-item">
                <a class="nav-link collapsed" href="Assistant_Document.html" data-target="#collapseUtilities"
                    aria-expanded="true" aria-controls="collapseUtilities">
                    <i class="fas fa-fw fa-table"></i>
                    <span>Document</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link collapsed" href="Assistant_Wallet.html" data-target="#collapseWallet"
                    aria-expanded="true" aria-controls="collapseWallet">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>Wallet</span>
                </a>
            </li>


            <hr class="sidebar-divider">


            <div class="sidebar-heading">
                Settings
            </div>


            <li class="nav-item">
                <a class="nav-link collapsed" href="Assistant_Settings.html" data-toggle="collapse"
                    data-target="#collapsePages" aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-wrench "></i>
                    <span>Settings</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Profile: </h6>
                        <a class="collapse-item" href="Assistant_Settings.html">Profile Settings</a>
                        <a class="collapse-item" href="Assistant_Settings.html">Forgot Password</a>
                    </div>
                </div>
            </li>


            <li class="nav-item">
                <a class="nav-link" href="Assistant_Support.html">
                    <i class="fas fa-fw fa-cog"></i>
                    <span>Help & support</span></a>
            </li>


            <hr class="sidebar-divider d-none d-md-block">


            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>


        </ul>

        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">

                <!--top nagivation bar include display username copy from here-->
                <nav class="bg-white shadow navbar navbar-expand navbar-light topbar mb-4 static-top">
                    <div>
                        <button class="btn btn-link d-md-none rounded-circle mr-3" id="sidebarToggleTop"><i
                                class="fas fa-bars"></i></button>
                    </div>

                    <!--Search Bar-->
                    <form
                        class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
                        <div class="input-group"><input class="bg-light border-0 form-control form-control small"
                                type="text" aria-describedby="basic-addon2" aria-label="Search"
                                placeholder="Search for...">
                            <div class="input-group-text input-group-append"><button class="btn btn-primary"
                                    type="button"><i class="fas fa-search fa-sm"></i></button></div>
                        </div>
                    </form>

                    <ul class="navbar-nav ml-auto">

                        <!--message-->
                        <li class="nav-item dropdown no-arrow mx-1">
                            <a id="messagesDropdown" class="nav-link dropdown-toggle" href="#" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <div class="sidebar-heading">Message </div>
                                <i class="fas fa-envelope fa-fw"></i>
                                <span class="badge badge-danger badge-counter">7</span>
                            </a>

                            <div class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="messagesDropdown">
                                <h6 class="dropdown-header">
                                    Message Center
                                </h6>
                                <a class="dropdown-item d-flex align-items-center" id=messagesDropdownfirst href="#">
                                    <div class="dropdown-list-image mr-3"><img class="rounded-circle"
                                            src="assets/img/undraw_profile_1.svg" alt="..." />
                                        <div class="status-indicator bg-success"></div>
                                    </div>
                                    <div>
                                        <div class="text-truncate">I had accept your order</div>
                                        <div class="small text-gray-500">Assistant Ashton</div>
                                    </div>
                                </a>
                                <a class="dropdown-item d-flex align-items-center" href="#">
                                    <div class="dropdown-list-image mr-3"><img class="rounded-circle"
                                            src="assets/img/undraw_profile_2.svg" alt="..." />
                                        <div class="status-indicator"></div>
                                    </div>
                                    <div>
                                        <div class="text-truncate">Your order had completed</div>
                                        <div class="small text-gray-500">Airi Satou · 1d</div>
                                    </div>
                                </a>
                                <a class="dropdown-item d-flex align-items-center" href="#">
                                    <div class="dropdown-list-image mr-3"><img class="rounded-circle"
                                            src="assets/img/undraw_profile_3.svg" alt="..." />
                                        <div class="status-indicator bg-warning"></div>
                                    </div>
                                    <div>
                                        <div class="text-truncate">alright, All done, your document had approved</div>
                                        <div class="small text-gray-500">Cedric Kelly · 2d</div>
                                    </div>
                                </a>

                                <a class="dropdown-item text-center small text-gray-500" href="#">Read More Messages</a>
                            </div>
                        </li>

                        <div class="topbar-divider d-none d-sm-block"></div>
                        <!--Edit username Here-->
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" id="userDropdown" role="button" data-toggle="dropdown"
                                aria-haspopup="true" aria-expanded="false">
                                <img class="img-profile rounded-circle" src="assets/img/undraw_profile_2.svg">
                                <strong><span id="loggedUserFName"
                                        class="mr-2 d-none d-lg-inline text-gray-600 small"></span></strong>
                            </a>

                            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="userDropdown">
                                <a class="dropdown-item" id="logout" data-toggle="modal" data-target="#logoutModal">
                                    <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Logout
                                </a>
                            </div>
                        </li>
                    </ul>
                </nav>

                <div class="container-fluid">
                    <div class="d-sm-flex justify-content-between align-items-center mb-4">
                        <h1 class="h3 mb-0 text-gray-800">Your Order</h1>
                    </div>

                    <div class="row">
                        <div class="col-lg-6 col-xl-12 mb-4">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="text-primary m-0 font-weight-bold">Order up Coming</h6>
                                </div>
                                <div class="card-body">
                                    <div>
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 190px;">Order Time</th>
                                                        <th style="width: 190px;">Student Details</th>
                                                        <th style="width: 190px;">status</th>
                                                        <th style="width: 190px;">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="assistantOrders"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 col-xl-12 mb-4">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="text-primary m-0 font-weight-bold">Order</h6>
                                </div>
                                <div class="card-body">
                                    <table id="datatablesSimple">
                                        <thead>
                                            <tr>
                                                <th>Start date</th>
                                                <th>Assistant</th>
                                                <th>status</th>
                                                <th>Amount</th>
                                            </tr>
                                        </thead>
                                        <tfoot>
                                            <tr>
                                                <th>Start date</th>
                                                <th>Assistant</th>
                                                <th>status</th>
                                                <th>Amount</th>
                                            </tr>
                                        </tfoot>
                                        <tbody>
                                            <tr>
                                                <td>2024/04/25</td>
                                                <td>Tiger Nixon</td>
                                                <td>Pending</td>
                                                <td>RM 100</td>
                                            </tr>
                                            <tr>
                                                <td>2011/07/25</td>
                                                <td>Garrett Winters</td>
                                                <td>Accepted</td>
                                                <td>RM 200</td>
                                            </tr>
                                            <tr>
                                                <td>2009/01/12</td>
                                                <td>Ashton Cox</td>
                                                <td>Completed</td>
                                                <td>RM 86</td>
                                            </tr>
                                            <tr>
                                                <td>2012/03/29</td>
                                                <td>Cedric Kelly</td>
                                                <td>Completed</td>
                                                <td>RM 22</td>
                                            </tr>
                                            <tr>
                                                <td>2008/11/28</td>
                                                <td>Airi Satou</td>
                                                <td>Pending</td>
                                                <td>RM 33</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="bg-white sticky-footer">
                <div class="container-fluid px-4">
                    <div class="text-left my-auto copyright justify-content-between small">
                        <span style="font-family: Amiko, sans-serif;">Copyright © Desvin Lee 2024</span>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <a class="scroll-to-top rounded" href="#page-top"><i class="fas fa-angle-up"></i></a>

    <!-- Accept confirmation Modal-->
    <div class="modal fade" role="dialog" tabindex="-1" id="confirmation" style="text-align: center;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Confirmation</h4><button class="btn-close" type="button" aria-label="Close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><i class="far fa-question-circle" style="font-size: 120px;"></i>
                    <p class="text-center">Are you sure accept this order ?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="button" id="confirmAcceptButton"
                        style="background: #3bacfd;border-color: #3bacfd;">comfirm</button>
                    <button class="btn btn-light" type="button" data-bs-dismiss="modal"
                        style="background: #f38181;">cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Undo Confirmation Modal -->
    <div class="modal fade" role="dialog" tabindex="-1" id="confirmUndoModal" style="text-align: center;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Confirmation</h4><button class="btn-close" type="button" aria-label="Close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><i class="far fa-question-circle" style="font-size: 120px;"></i>
                    <p class="text-center"> Are you sure you want to Undo this order? Once Undo, the student
                        will see its status change
                        back to Pending.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="button" id="confirmUndoButton"
                        style="background: #3bacfd;border-color: #3bacfd;">confirm</button>
                    <button class="btn btn-light" type="button" data-bs-dismiss="modal"
                        style="background: #f38181;">cancel</button>
                </div>
            </div>
        </div>
    </div>


    <div id="chatModal" class="card position-absolute bottom-0 end-0"
        style="width: 30rem; margin-right: 60px; display: none;">
        <div class="card-header bg-primary d-flex justify-content-between align-items-center" style="cursor: pointer;">
            <small class="text-white">Chat box</small>
            <button id="closeButton" class="btn btn-danger btn-sm" type="button" onclick="CloseChat()"> X
            </button>
        </div>
        <div class="card-body" id="chatBox" style="height: 25rem; overflow-y: auto;">
        </div>
        <div class="row p-2">
            <div class="col">
                <input id="chatInput" class="form-control" type="text" placeholder="Type a message">
            </div>
            <div class="col-auto">
                <button id="sendBtn" class="btn btn-primary" type="button" onclick="sendMessage()">
                    <i class="far fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="modal fade" role="dialog" tabindex="-1" id="logoutModal" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5><button aria-label="Close"
                        class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span></button>
                </div>
                <div class="modal-body"><span>Select "Logout" below if you are ready to end your current session.</span>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" data-dismiss="modal"
                        type="button">Cancel</button><a class="btn btn-primary" role="button"
                        href="login.html">Logout</a></div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/vendor/jquery/jquery.min.js"></script>
    <script src="assets/js/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="assets/js/js/sb-admin-2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js"></script>
    <script src="assets/js/js/datatables-simple-demo.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/js/Navigationbar.js"></script>

    <script type="module">
        //src="assets/js/js/Assistant_orderlist.js"
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getDatabase, ref, child, onValue, get, set, update, remove, push } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js"
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAifkBmMPwQLTqRu8nYFU1dqej2dlX33Bk",
            authDomain: "usaas-4230f.firebaseapp.com",
            databaseURL: "https://usaas-4230f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "usaas-4230f",
            storageBucket: "usaas-4230f.firebasestorage.app",
            messagingSenderId: "1057123876526",
            appId: "1:1057123876526:web:fb4c3c0e6b2407295f773f",
            measurementId: "G-NSW66N1VGP"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);
        const firestore = getFirestore(app);

        let studentlist = [];
        let tbody = document.getElementById('assistantOrders');

        let orderToUndoId = null;

        const setSelectedOrderToUndo = (orderId) => {
            orderToUndoId = orderId;
            console.log("Setting order ID to undo:", orderToUndoId);
        };

        let inactivityTimer;

        // Start 30-minute session timer
        function startInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                signOut(auth)
                    .then(() => {
                        alert("Session expired due to inactivity.");
                        localStorage.removeItem("loggedInUserId");
                        window.location.href = "login.html";
                    })
                    .catch((error) => {
                        console.error("Auto-logout failed:", error);
                    });
            }, 30 * 60 * 1000); // 30 minutes
        }

        // Reset session timer on user activity
        function resetTimerOnActivity() {
            ["click", "mousemove", "keypress", "scroll"].forEach(event =>
                window.addEventListener(event, startInactivityTimer)
            );
        }

        // Main logic
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                console.warn("Assistant not logged in.");
                window.location.href = "login.html";
                return;
            }

            try {
                startInactivityTimer();
                resetTimerOnActivity();

                const uid = user.uid;
                const userDocRef = doc(firestore, "users", uid);
                const userDocSnap = await getDoc(userDocRef);

                if (!userDocSnap.exists()) {
                    console.error("User doc not found.");
                    return;
                }

                const userData = userDocSnap.data();
                const assistantPhone = userData.phoneNumber;
                console.log("Assistant Phone:", assistantPhone);

                // Show assistant name in UI
                const nameEl = document.getElementById("loggedUserFName");
                if (nameEl) nameEl.innerText = userData.firstName || "Assistant";

                // Get student orders from RTDB
                const snapshot = await get(ref(rtdb, "StudentOrders"));
                if (!snapshot.exists()) {
                    console.log("No student orders found.");
                    return;
                }

                const allOrders = snapshot.val();
                const ordersToDisplay = [];

                for (const studentPhone in allOrders) {
                    const studentOrderList = allOrders[studentPhone];
                    for (const orderId in studentOrderList) {
                        const order = studentOrderList[orderId];
                        order.id = orderId;
                        order.phone = studentPhone;

                        // Only show relevant orders
                        if (order.status === "Pending" || order.status === "Accepted") {
                            ordersToDisplay.push(order);
                        }
                    }
                }

                AddAllRecords(ordersToDisplay); // Renders to your UI

            } catch (error) {
                console.error("Error loading assistant orders:", error);
            }
        });

        const loadAssistantOrders = async () => {
            try {
                const allOrdersRef = ref(db, "StudentOrders");
                const snapshot = await get(allOrdersRef);

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const allOrders = [];

                    // Iterate over all phone numbers and push their orders
                    for (const phone in data) {
                        const ordersByPhone = data[phone];
                        for (const orderId in ordersByPhone) {
                            const order = ordersByPhone[orderId];
                            order.id = orderId; // store orderId for accept/undo use
                            order.phone = phone; // store phone for accept/undo use
                            allOrders.push(order);
                        }
                    }

                    AddAllRecords(allOrders); // render into assistantOrders table
                    console.log(" Assistant order list loaded.");
                } else {
                    console.log("No orders found.");
                }
            } catch (error) {
                console.error(" Error loading assistant orders:", error);
            }
        };


        const AddSingleRecord = (student) => {
            let trow = document.createElement('tr');
            let td1 = document.createElement('td');
            let td2 = document.createElement('td');
            let td3 = document.createElement('td');
            let td4 = document.createElement('td');

            td1.innerHTML = student.orderTime || "Unknown";
            td2.innerHTML = `${student.nameofstudent?.firstname || "Unknown"} ${student.nameofstudent?.lastname || "Unknown"} 
        <br>${student.faculty?.facultyname || "Unknown"}
        <br>RM ${student.price || "Unknown"}
        <br><strong>${student.phone || "No Phone"}`;


            let statusColor;
            if (student.status === "Accepted") {
                statusColor = "#0ee535"; // Green
            } else if (student.status === "Completed") {
                statusColor = "#95E1D3"; // Light Blue/Green
            } else if (student.status === "Pending") {
                statusColor = "#fce38a";
            } else {
                statusColor = "000000"; // Default color (e.g., for "Pending" or other unknown statuses)
            }

            td3.innerHTML = `<i class="far fa-stop-circle" style="color: ${statusColor}; vertical-align: middle;">
                    </i> ${student.status || "Pending"}`;

            if (student.status === "Pending") {
                let acceptButton = document.createElement('button');
                acceptButton.className = "btn btn-primary";
                acceptButton.type = "button";
                acceptButton.style = "margin-top: 10px; border-radius: 6px; background: #95E1D3; color: black;";
                acceptButton.innerHTML = '<i class="fas fa-check"></i> Accept';
                acceptButton.setAttribute("data-bs-toggle", "modal");
                acceptButton.setAttribute("data-bs-target", "#confirmation"); // Target the confirmation modal
                acceptButton.onclick = () => setSelectedOrderToAccept(student.phone, student.id); // Store order details
                td4.appendChild(acceptButton);
            }
            if (student.status === "Accepted") {
                let undoButton = document.createElement('button');
                undoButton.className = "btn btn-primary";
                undoButton.type = "button";
                undoButton.style = "border-radius: 6px; background: #3bacfd; color: white; margin-top: 10px;";
                undoButton.innerHTML = '<i class="fas fa-handshake"></i> Undo';
                undoButton.setAttribute("data-bs-toggle", "modal");
                undoButton.setAttribute("data-bs-target", "#confirmUndoModal");
                undoButton.dataset.orderId = student.id;
                undoButton.dataset.studentPhone = student.phone;
                undoButton.onclick = () => {
                    setSelectedOrderToUndo(student.id);
                };
                td4.appendChild(undoButton);
            }

            trow.append(td1, td2, td3, td4);
            tbody.append(trow);
        };

        document.addEventListener('DOMContentLoaded', () => {
            const confirmUndoButton = document.getElementById('confirmUndoButton'); // Replace with the actual ID of your modal's confirm button
            if (confirmUndoButton) {
                confirmUndoButton.addEventListener('click', undoOrder);

            } else {
                undoModal
                console.error("Confirm undo button not found in the DOM.");
            }
        });

        const AddAllRecords = (orders) => {
            tbody.innerHTML = "";
            if (orders) {
                orders.forEach(student => {
                    AddSingleRecord(student);
                });
            }
        };

        let orderToAccept = {
            studentPhone: null,
            orderId: null
        };

        const setSelectedOrderToAccept = (phone, id) => {
            orderToAccept.studentPhone = phone;
            orderToAccept.orderId = id;
            console.log("Setting order to accept:", orderToAccept);
        };

        document.addEventListener('DOMContentLoaded', () => {
            const confirmAcceptButton = document.getElementById('confirmAcceptButton');
            if (confirmAcceptButton) {
                confirmAcceptButton.addEventListener('click', () => {
                    if (orderToAccept.studentPhone && orderToAccept.orderId) {
                        AcceptOrder(orderToAccept.studentPhone, orderToAccept.orderId);
                        // Optionally, you can manually hide the modal here if data-bs-dismiss isn't working reliably
                        const confirmationModal = bootstrap.Modal.getInstance(document.getElementById('confirmation'));
                        if (confirmationModal) {
                            confirmationModal.hide();
                        }
                        // Reset the stored order details after accepting (optional, depending on your flow)
                        orderToAccept.studentPhone = null;
                        orderToAccept.orderId = null;
                    } else {
                        console.error("No order selected to accept.");
                        alert("Please select an order to accept.");
                    }
                });
            } else {
                console.error("Confirm accept button not found in the DOM.");
            }
        });

        const AcceptOrder = (studentPhone, orderId) => { // Accept phone number and order ID
            const user = auth.currentUser;
            if (!user) {
                console.error("No assistant logged in");
                return;
            }

            const assistantUid = user.uid;

            getDoc(doc(firestore, "users", assistantUid)).then((docSnap) => {
                if (docSnap.exists()) {
                    const assistantData = docSnap.data();

                    update(ref(db, `StudentOrders/${studentPhone}/${orderId}`), { // Use StudentOrders and phone number
                        status: "Accepted",
                        assistant: {
                            name: assistantData.firstName || "Unknown Assistant",
                            phone: assistantData.phoneNumber || "Unknown Phone"
                        }
                    }).then(() => {
                        alert("Order Accepted!");
                        window.location.reload();
                    }).catch((error) => {
                        console.error("Error updating status:", error);
                    });
                } else {
                    console.error("Assistant details not found in Firestore");
                }
            }).catch((error) => {
                console.error("Error fetching assistant details:", error);
            });
        };

        const undoOrder = () => {
            console.log("undoOrder called.");
            console.log("Current user:", auth.currentUser); // Log auth state

            if (!orderToUndoId) {
                console.error("No order ID selected for retrieval.");
                alert("No order selected to undo.");
                return;
            }
            const user = auth.currentUser;

            getDoc(doc(firestore, "users", user.uid)).then((docSnap) => {
                const currentAssistantPhoneNumber = docSnap.data()?.phoneNumber;
                const assistantName = docSnap.data()?.firstName + " " + docSnap.data()?.lastName;

                if (!currentAssistantPhoneNumber) {
                    console.error("Assistant phone number not found in Firestore for user:", user.uid);
                    alert("Error retrieving order.");
                    return;
                }

                // Retrieve the phone number and order ID from the selected order
                get(ref(db, `StudentOrders`)).then((snapshot) => {
                    let studentPhoneNumber = null;
                    snapshot.forEach((studentPhoneSnapshot) => {
                        const orders = studentPhoneSnapshot.val();
                        if (orders && orders[orderToUndoId]) {
                            studentPhoneNumber = studentPhoneSnapshot.key;
                        }
                    });
                    if (!studentPhoneNumber) {
                        console.error("Student phone number not found for order ID:", orderToUndoId);
                        alert("Error retrieving order.");
                        return;
                    }

                    const orderRef = ref(db, `StudentOrders/${studentPhoneNumber}/${orderToUndoId}`);
                    return update(orderRef, {
                        status: "Pending",
                        assistant: null,
                    });
                })
                    .then(() => {
                        alert("Order undo successfully!");
                        window.location.reload();
                        orderToUndoId = null;
                        const undoModal = bootstrap.Modal.getInstance(document.getElementById('confirmUndoModal'));
                        if (undoModal) {
                            undoModal.hide();
                        }
                    })
                    .catch((error) => {
                        console.error("Error retrieving order:", error);
                        alert("Failed to undo order.");
                    });

            });
        };




        //chat function start from here

        let currentChatID = null;

        document.getElementById("messagesDropdownfirst").addEventListener("click", function () {
            const chatID = "chatID123"; // Replace with the correct chat ID logic
            OpenChat(chatID);
        });

        function OpenChat(chatID) {
            console.log("Chat Opened with ID:", chatID);
            currentChatID = chatID;

            const chatModal = document.getElementById("chatModal");
            if (chatModal) {
                chatModal.style.display = "block";
                loadMessages(chatID);
            } else {
                console.error("Chat modal not found!");
            }
        }

        function loadMessages(chatID) {
            if (!chatID) return;

            const chatRef = ref(db, "chats/" + chatID + "/messages"); //  Correct ref syntax

            onValue(chatRef, (snapshot) => {
                const messages = snapshot.val();
                displayMessages(messages); //  Call display function
            });
        }

        let currentUserRole = "assistant";

        function displayMessages(messages) {
            const chatBox = document.getElementById("chatBox");
            if (!chatBox) {
                console.error("Chat box not found!");
                return;
            }

            chatBox.innerHTML = ""; //  Clear old messages to prevent duplicates

            if (messages) {
                //  Convert Firebase object to sorted array (by timestamp)
                const sortedMessages = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);

                sortedMessages.forEach(msg => {
                    const messageElement = document.createElement("p");

                    const isOwner = msg.sender === currentUserRole; // "student" or "assistant"
                    const bgColor = isOwner ? "bg-success" : "bg-primary"; // Green for own, Blue for received
                    const textAlign = isOwner ? "text-end" : "text-start"; // Align right for own, left for received

                    messageElement.className = `${textAlign} mb-2`;
                    messageElement.innerHTML = `<small class="${bgColor} p-3 text-white rounded-1 d-inline-block">${msg.text}</small>`;

                    chatBox.appendChild(messageElement); //  Append correctly
                });
            }

            chatBox.scrollTop = chatBox.scrollHeight; //  Auto-scroll to latest message
        };

        window.CloseChat = function () {
            let chatModal = document.getElementById("chatModal");
            if (chatModal) {
                chatModal.style.display = "none"; // Hide modal
            }
        };

        window.sendMessage = function () {
            let chatInput = document.getElementById("chatInput");
            let messageText = chatInput.value.trim();

            if (!messageText) return; // Prevent sending empty messages

            let newMessage = {
                sender: "assistant", // Modify this dynamically if needed
                text: messageText,
                timestamp: Date.now()
            };

            //  Push message to Firebase
            const chatRef = ref(db, "chats/" + currentChatID + "/messages");
            push(chatRef, newMessage)
                .then(() => {
                    console.log("Message sent to Firebase!");
                    chatInput.value = ""; // Clear input after sending
                })
                .catch((error) => {
                    console.error("Error sending message:", error);
                });
        };

        window.handleKeyPress = function (event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        };

        document.addEventListener("DOMContentLoaded", function () {
            let chatInput = document.getElementById("chatInput");
            if (chatInput) {
                chatInput.addEventListener("keypress", function (event) {
                    if (event.key === "Enter") {
                        sendMessage(); //  Calls sendMessage when Enter is pressed
                    }
                });
            } else {
                console.error("Error: chatInput field not found!");
            }

            const confirmUndoButton = document.getElementById('confirmUndoButton');
            if (confirmUndoButton) {
                confirmUndoButton.addEventListener('click', undoOrder);
            }

        });

        tbody.addEventListener('click', (event) => {
            if (event.target.classList.contains('undo-btn')) {
                const orderId = event.target.dataset.orderId;
                setSelectedOrderToUndo(orderId);
                const undoModal = new bootstrap.Modal(document.getElementById('confirmUndoModal'));
                undoModal.show();
            }
        });


    </script>
</body>

</html>