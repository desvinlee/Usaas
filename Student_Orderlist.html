<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Student Order list</title>
    <link rel="stylesheet" href="assets/css/css/sb-admin-2.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
</head>

<body id="page-top">
    <div id="wrapper">
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <hr class="sidebar-divider my-0">

            <div class="sidebar-heading">
                <img width="100" height="80" src="assets/img/Homepage/usaas_logo.svg" />
            </div>

            <li class="nav-item active">
                <a class="nav-link" href="Student_Dashboard.html">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Student Dashboard</span></a>
            </li>


            <hr class="sidebar-divider">


            <div class="sidebar-heading">
                Interface
            </div>


            <li class="nav-item">
                <a class="nav-link collapsed" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="true"
                    aria-controls="collapseTwo">
                    <i class="fas fa-fw fa-chart-area"></i>
                    <span>Order</span>
                </a>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Order List:</h6>
                        <a class="collapse-item" href="Student_Createorder.html">Create Order</a>
                        <a class="collapse-item" href="Student_Orderlist.html">Check Order</a>
                    </div>
                </div>
            </li>


            <li class="nav-item">
                <a class="nav-link collapsed" href="Student_Document.html" data-target="#collapseUtilities"
                    aria-expanded="true" aria-controls="collapseUtilities">
                    <i class="fas fa-fw fa-table"></i>
                    <span>Document</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link collapsed" href="Student_Wallet.html" data-target="#collapseWallet"
                    aria-expanded="true" aria-controls="collapseWallet">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>Wallet</span>
                </a>
            </li>


            <hr class="sidebar-divider">


            <div class="sidebar-heading">
                Settings
            </div>


            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                    aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-wrench "></i>
                    <span>Settings</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Profile: </h6>
                        <a class="collapse-item" href="Student_Settings.html">Profile Settings</a>
                        <a class="collapse-item" href="Student_Settings.html">Forgot Password</a>
                    </div>
                </div>
            </li>


            <li class="nav-item">
                <a class="nav-link" href="Student_Support.html">
                    <i class="fas fa-fw fa-cog"></i>
                    <span>Help & support</span></a>
            </li>


            <hr class="sidebar-divider d-none d-md-block">


            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>


        </ul>

        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <!--top nagivation bar include display username copy from here-->
                <nav class="bg-white shadow navbar navbar-expand navbar-light topbar mb-4 static-top">
                    <div>
                        <button class="btn btn-link d-md-none rounded-circle mr-3" id="sidebarToggleTop"><i
                                class="fas fa-bars"></i></button>
                    </div>

                    <!--Search Bar-->
                    <form
                        class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
                        <div class="input-group"><input class="bg-light border-0 form-control form-control small"
                                type="text" aria-describedby="basic-addon2" aria-label="Search"
                                placeholder="Search for...">
                            <div class="input-group-text input-group-append"><button class="btn btn-primary"
                                    type="button"><i class="fas fa-search fa-sm"></i></button></div>
                        </div>
                    </form>

                    <ul class="navbar-nav ml-auto">

                        <!--message-->
                        <li class="nav-item dropdown no-arrow mx-1">
                            <a id="messagesDropdown" class="nav-link dropdown-toggle" href="#" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <div class="sidebar-heading">Message </div>
                                <i class="fas fa-envelope fa-fw"></i>
                            </a>

                            <div class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="messagesDropdown">
                                <h6 class="dropdown-header">
                                    Message Center
                                </h6>
                                <a class="dropdown-item d-flex align-items-center" id=messagesDropdownfirst href="#">
                                    <div class="dropdown-list-image mr-3"><img class="rounded-circle"
                                            src="assets/img/undraw_profile_1.svg" alt="..." />
                                        <div class="status-indicator bg-success"></div>
                                    </div>
                                    <div>
                                        <div class="text-truncate">I had accept your order</div>
                                        <div class="small text-gray-500">Assistant Ashton</div>
                                    </div>
                                </a>
                                <a class="dropdown-item d-flex align-items-center" href="#">
                                    <div class="dropdown-list-image mr-3"><img class="rounded-circle"
                                            src="assets/img/undraw_profile_2.svg" alt="..." />
                                        <div class="status-indicator"></div>
                                    </div>
                                    <div>
                                        <div class="text-truncate">Your order had completed</div>
                                        <div class="small text-gray-500">Airi Satou · 1d</div>
                                    </div>
                                </a>
                                <a class="dropdown-item d-flex align-items-center" href="#">
                                    <div class="dropdown-list-image mr-3"><img class="rounded-circle"
                                            src="assets/img/undraw_profile_3.svg" alt="..." />
                                        <div class="status-indicator bg-warning"></div>
                                    </div>
                                    <div>
                                        <div class="text-truncate">alright, All done, your document had approved</div>
                                        <div class="small text-gray-500">Cedric Kelly · 2d</div>
                                    </div>
                                </a>

                                <a class="dropdown-item text-center small text-gray-500" href="#">Read More Messages</a>
                            </div>
                        </li>

                        <div class="topbar-divider d-none d-sm-block"></div>
                        <!--Edit username Here-->
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" id="userDropdown" role="button" data-toggle="dropdown"
                                aria-haspopup="true" aria-expanded="false">
                                <img class="img-profile rounded-circle" src="assets/img/undraw_profile_2.svg">
                                <strong><span id="loggedUserFName"
                                        class="mr-2 d-none d-lg-inline text-gray-600 small"></span></strong>
                            </a>

                            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="userDropdown">
                                <a class="dropdown-item" id="logout" data-toggle="modal" data-target="#logoutModal">
                                    <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Logout
                                </a>
                            </div>
                        </li>
                    </ul>
                </nav>

                <!--Main Content-->
                <div class="container-fluid">
                    <div class="d-sm-flex justify-content-between align-items-center mb-4">
                        <h1 class="h3 mb-0 text-gray-800">Order List</h1>
                    </div>

                    <div class="row" style="margin-right: 0;">
                        <div class="col">
                            <div class="card shadow mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-xl-2"><a class="nav-link" href="Student_Orderlist.html">Order
                                                List</a></div>
                                        <div class="col-xl-3"><a class="nav-link" href="Student_Createorder.html">Your
                                                Order</a></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 col-xl-12 mb-4">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="text-primary m-0 font-weight-bold">Order up Coming</h6>
                                </div>
                                <div class="card-body">
                                    <div>
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 190px;">Order Time</th>
                                                        <th style="width: 190px;">Student Details</th>
                                                        <th style="width: 190px;">status</th>
                                                        <th style="width: 190px;">Assistant Details</th>
                                                        <th style="width: 190px;">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="studentOrders"></tbody>

                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6 col-xl-12 mb-4">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="text-primary m-0 font-weight-bold">Order</h6>
                                </div>
                                <div class="card-body">
                                    <table id="datatablesSimple">
                                        <thead>
                                            <tr>
                                                <th>Start date</th>
                                                <th>Assistant</th>
                                                <th>status</th>
                                                <th>Amount</th>
                                            </tr>
                                        </thead>
                                        <tfoot>
                                            <tr>
                                                <th>Start date</th>
                                                <th>Assistant</th>
                                                <th>status</th>
                                                <th>Amount</th>
                                            </tr>
                                        </tfoot>
                                        <tbody>
                                            <tr>
                                                <td>2024/04/25</td>
                                                <td>Tiger Nixon</td>
                                                <td>Pending</td>
                                                <td>RM 100</td>
                                            </tr>
                                            <tr>
                                                <td>2011/07/25</td>
                                                <td>Garrett Winters</td>
                                                <td>Accepted</td>
                                                <td>RM 200</td>
                                            </tr>
                                            <tr>
                                                <td>2009/01/12</td>
                                                <td>Ashton Cox</td>
                                                <td>Completed</td>
                                                <td>RM 86</td>
                                            </tr>
                                            <tr>
                                                <td>2012/03/29</td>
                                                <td>Cedric Kelly</td>
                                                <td>Completed</td>
                                                <td>RM 22</td>
                                            </tr>
                                            <tr>
                                                <td>2008/11/28</td>
                                                <td>Airi Satou</td>
                                                <td>Pending</td>
                                                <td>RM 33</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="bg-white sticky-footer">
                <div class="container-fluid px-4">
                    <div class="text-left my-auto copyright justify-content-between small">
                        <span style="font-family: Amiko, sans-serif;">Copyright © Desvin Lee 2024</span>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <a class="scroll-to-top rounded" href="#page-top"><i class="fas fa-angle-up"></i></a>

    <div id="chatModal" class="card position-absolute bottom-0 end-0"
        style="width: 30rem; margin-right: 60px; display: none;">
        <div class="card-header bg-primary d-flex justify-content-between align-items-center" style="cursor: pointer;">
            <small class="text-white">Chat box</small>
            <button id="closeButton" class="btn btn-danger btn-sm" type="button" onclick="CloseChat()"> X
            </button>
        </div>
        <div class="card-body" id="chatBox" style="height: 25rem; overflow-y: auto;">
            <!-- Messages will be dynamically added here -->
        </div>
        <div class="row p-2">
            <div class="col">
                <input id="chatInput" class="form-control" type="text" placeholder="Type a message">
            </div>
            <div class="col-auto">
                <button id="sendBtn" class="btn btn-primary" type="button" onclick="sendMessage()">
                    <i class="far fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="modal fade" role="dialog" tabindex="-1" id="logoutModal" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5><button aria-label="Close"
                        class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span></button>
                </div>
                <div class="modal-body"><span>Select "Logout" below if you are ready to end your current session.</span>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" data-dismiss="modal"
                        type="button">Cancel</button><a class="btn btn-primary" role="button"
                        href="login.html">Logout</a></div>
            </div>
        </div>
    </div>

    <!-- Complete Confirmation Modal -->
    <div class="modal fade" id="completeConfirmation" tabindex="-1" role="dialog" aria-labelledby="completeLabel"
        aria-hidden="true" style="text-align: center;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Completion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <i class="far fa-check-circle" style="font-size: 100px; color: green;"></i>
                    <p class="text-center">Are you sure this order has been completed?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" type="button" id="confirmCompleteButton">Complete</button>
                    <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmation" tabindex="-1" role="dialog" aria-labelledby="deleteLabel"
        aria-hidden="true" style="text-align: center;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <i class="fas fa-exclamation-triangle" style="font-size: 100px; color: red;"></i>
                    <p class="text-center mt-3">Are you sure you want to delete this order?</p>
                    <p class="text-center text-danger">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" type="button" id="confirmDeleteButton">Delete</button>
                    <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Rate Order Modal -->
    <div class="modal fade" id="rateOrderModal" tabindex="-1" aria-labelledby="rateOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rateOrderModalLabel">Rate Your Experience</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>How would you rate your experience?</p>
                    <div class="star-rating">
                        <span class="star" data-rating="1">&#9734;</span>
                        <span class="star" data-rating="2">&#9734;</span>
                        <span class="star" data-rating="3">&#9734;</span>
                        <span class="star" data-rating="4">&#9734;</span>
                        <span class="star" data-rating="5">&#9734;</span>
                    </div>
                    <div class="mb-3">
                        <label for="ratingDetails" class="form-label">Optional Feedback:</label>
                        <textarea class="form-control" id="ratingDetails" rows="3"></textarea>
                    </div>
                    <input type="hidden" id="ratedOrderId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="submitRating">Submit</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/vendor/jquery/jquery.min.js"></script>
    <script src="assets/js/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="assets/js/js/sb-admin-2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js"></script>
    <script src="assets/js/js/datatables-simple-demo.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/js/Navigationbar.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, set, remove, get } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAifkBmMPwQLTqRu8nYFU1dqej2dlX33Bk",
            authDomain: "usaas-4230f.firebaseapp.com",
            databaseURL: "https://usaas-4230f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "usaas-4230f",
            storageBucket: "usaas-4230f.firebasestorage.app",
            messagingSenderId: "1057123876526",
            appId: "1:1057123876526:web:fb4c3c0e6b2407295f773f",
            measurementId: "G-NSW66N1VGP"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const rtdb = getDatabase(app); // Realtime Database
        const auth = getAuth(app);
        const db = getDatabase(app);
        const firestore = getFirestore(app); // Initialize Firestore

        let studentlist = [];
        let tbody = document.getElementById('studentOrders');

        let inactivityTimer;


        function startInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                signOut(auth).then(() => {
                    alert("Session expired due to inactivity.");
                    localStorage.removeItem("loggedInUserId");
                    window.location.href = "login.html"; // or your login route
                });
            }, 5 * 60 * 1000);
        }

        //  Reset timer on user activity
        function resetTimerOnActivity() {
            ["mousemove", "keypress", "click", "scroll"].forEach(event => {
                window.addEventListener(event, startInactivityTimer);
            });
        }

        // Main Logic
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Not logged in — redirect
                window.location.href = "login.html";
                return;
            }

            try {
                // Start inactivity check
                startInactivityTimer();
                resetTimerOnActivity();

                const uid = user.uid;
                localStorage.setItem("loggedInUserId", uid); // ✅ store in case needed elsewhere

                const userDocRef = doc(firestore, "users", uid);
                const userDocSnap = await getDoc(userDocRef);

                if (!userDocSnap.exists()) throw new Error("User not found");

                const userData = userDocSnap.data();

                // ✅ Display student's first name
                document.getElementById('loggedUserFName').innerText = userData.firstName || "User";

                // ✅ Get phone number & load orders
                const studentPhone = userData.phoneNumber;
                const ordersRef = ref(db, `StudentOrders/${studentPhone}`);
                const snapshot = await get(ordersRef);

                if (snapshot.exists()) {
                    const orders = snapshot.val();
                    displayStudentOrders(orders, studentPhone); // ✅ your existing display function
                } else {
                    console.log("No orders found for this student.");
                }

            } catch (error) {
                console.error("Error loading student orders:", error);
            }
        });



        async function getPhoneNumber(uid) {
            const phoneRef = ref(rtdb, `UserPhoneLink/${uid}/phoneNumber`);
            const snapshot = await get(phoneRef);
            if (snapshot.exists()) return snapshot.val();
            return null;
        }


        async function loadStudentOrders() {
            const user = auth.currentUser;
            if (!user) {
                console.error("User not authenticated");
                return;
            }

            const uid = user.uid;
            const phoneNumber = await getPhoneNumber(uid);
            console.log("Student Phone Number:", phoneNumber);

            if (!phoneNumber) {
                console.error("Phone number not found for user");
                return;
            }

            const ordersRef = ref(rtdb, `StudentOrders/${phoneNumber}`);
            try {
                const snapshot = await get(ordersRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    console.log("Student Orders:", data);
                    displayStudentOrders(data);
                } else {
                    console.log("No orders found for this student.");
                }
            } catch (error) {
                console.error(" Error loading student orders:", error);
            }
        }

        const AddSingleStudentOrder = (student) => {
            let trow = document.createElement('tr');
            let td1 = document.createElement('td');
            let td2 = document.createElement('td');
            let td3 = document.createElement('td');
            let td4 = document.createElement('td');
            let td5 = document.createElement('td');

            td1.innerHTML = student.orderTime || "Unknown";
            td2.innerHTML = `${student.nameofstudent?.firstname || "Unknown"} ${student.nameofstudent?.lastname || "Unknown"}
        <br>${student.faculty?.facultyname || "Unknown"}
        <br>RM ${student.price || "Unknown"}
        <br><strong>${student.phone || "No Phone"}<strong>`;

            let statusColor;
            if (student.status === "Accepted") {
                statusColor = "#0ee535"; // Green
            } else if (student.status === "Completed") {
                statusColor = "#95E1D3"; // Light Blue/Green
            } else if (student.status === "Pending") {
                statusColor = "#fce38a";
            } else {
                statusColor = "000000"; // Default color (e.g., for "Pending" or other unknown statuses)
            }

            td3.innerHTML = `<i class="far fa-stop-circle" style="color: ${statusColor}; vertical-align: middle;">
                    </i> ${student.status || "Pending"}`;

            if (student.assistant && student.assistant.name) {
                td4.innerHTML = `${student.assistant.name} <br> ${student.assistant.phone}`;
            } else {
                td4.innerHTML = "Not Assigned";
            }

            td5.innerHTML = "";
            let completeButton;

            if (student.status === "Pending") {
                let deleteButton = document.createElement('button');
                deleteButton.className = "btn btn-danger ms-2";
                deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
                deleteButton.setAttribute("data-bs-toggle", "modal");
                deleteButton.setAttribute("data-bs-target", "#deleteConfirmation");
                deleteButton.onclick = () => setSelectedOrderToDelete(student.parentPhoneKey, student.id);
                td5.appendChild(deleteButton);
            }

            if (student.status === "Accepted") {
                let chatButton = document.createElement('button');
                chatButton.className = "btn btn-primary";
                chatButton.type = "button";
                chatButton.style = "border-radius: 6px; background: #3bacfd; color: white;";
                chatButton.innerHTML = '<i class="fas fa-comment"></i> Chat';
                chatButton.setAttribute("data-bs-toggle", "collapse");
                chatButton.setAttribute("data-bs-target", "#chatModal");
                chatButton.onclick = () => OpenChat('chatID123');
                td5.appendChild(chatButton);
                td5.appendChild(document.createElement("br"));

                let completeButton = document.createElement('button');
                completeButton.className = "btn btn-success";
                completeButton.innerHTML = '<i class="fas fa-check-circle"></i> Complete';
                completeButton.style = "margin-top: 10px;";
                completeButton.setAttribute("data-bs-toggle", "modal");
                completeButton.setAttribute("data-bs-target", "#completeConfirmation");
                completeButton.onclick = () => setSelectedOrderToComplete(student.parentPhoneKey, student.id);
                td5.appendChild(completeButton);
            }

            if (student.status === "Completed") {
                let rateButton = document.createElement('button');
                rateButton.className = "btn btn-sm btn-warning rate-order-btn";
                rateButton.type = "button";
                rateButton.style = "border-radius: 6px; background: #ffc107; color: black;";
                rateButton.innerHTML = '<i class="fas fa-star"></i> Rate';
                rateButton.setAttribute("data-bs-toggle", "modal");
                rateButton.setAttribute("data-bs-target", "#rateOrderModal");
                rateButton.dataset.orderId = student.id;
                td5.appendChild(rateButton);
            }

            trow.append(td1, td2, td3, td4, td5);
            tbody.appendChild(trow);
        };


        const displayStudentOrders = (ordersObject, parentPhoneKey) => {
            document.getElementById("studentOrders").innerHTML = "";

            Object.entries(ordersObject).forEach(([orderId, orderData]) => {
                const fullOrder = {
                    ...orderData,
                    id: orderId,
                    parentPhoneKey: parentPhoneKey
                };
                AddSingleStudentOrder(fullOrder);
            });
        };


        let completePhoneNumber = null;
        let completeOrderId = null;

        function setSelectedOrderToComplete(phone, orderId) {
            completePhoneNumber = phone;
            completeOrderId = orderId;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const confirmCompleteButton = document.getElementById('confirmCompleteButton');
            if (confirmCompleteButton) {
                confirmCompleteButton.addEventListener('click', () => {
                    if (completePhoneNumber && completeOrderId) {
                        CompleteOrder(completePhoneNumber, completeOrderId);
                    } else {
                        alert("No order selected to complete.");
                    }
                });
            } else {
                console.error("Confirm Complete button not found in the DOM.");
            }
        });

        const CompleteOrder = async (studentPhone, orderId) => {
            try {
                const orderRef = ref(db, `StudentOrders/${studentPhone}/${orderId}`);
                await update(orderRef, {
                    status: "Completed"
                });
                alert("Order marked as completed!");
                const modalElement = document.getElementById('acceptConfirmationModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
                window.location.reload();
            } catch (error) {
                console.error("Failed to mark order complete:", error);
                alert("Failed to complete order. Please try again.");
            }
        };

        let deletePhoneNumber = null;
        let deleteOrderId = null;

        function setSelectedOrderToDelete(phone, orderId) {
            deletePhoneNumber = phone;
            deleteOrderId = orderId;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const confirmDeleteButton = document.getElementById('confirmDeleteButton');
            if (confirmDeleteButton) {
                confirmDeleteButton.addEventListener('click', () => {
                    if (deletePhoneNumber && deleteOrderId) {
                        DeleteOrder(deletePhoneNumber, deleteOrderId);
                    } else {
                        alert("No order selected to delete.");
                    }
                });
            } else {
                console.error("Confirm Delete button not found in the DOM.");
            }
        });

        const DeleteOrder = async (studentPhone, orderId) => {
            try {
                const orderRef = ref(db, `StudentOrders/${studentPhone}/${orderId}`);
                await remove(orderRef); // Use the remove function to delete data
                alert("Order deleted successfully!");
                const modalElement = document.getElementById('deleteConfirmation');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
                window.location.reload();
            } catch (error) {
                console.error("Failed to delete order:", error);
                alert("Failed to delete order. Please try again.");
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            const rateOrderModal = document.getElementById('rateOrderModal');
            const submitRatingButton = rateOrderModal?.querySelector('#submitRating');
            const starRatingContainer = rateOrderModal?.querySelector('.star-rating');
            const ratingDetailsInput = rateOrderModal?.querySelector('#ratingDetails');
            const ratedOrderIdInput = rateOrderModal?.querySelector('#ratedOrderId');

            let selectedRating = 0;
            let currentOrderIdToRate = null;

            // Event listener for the "Rate" button in the order list
            const orderListTable = document.getElementById('studentOrders');
            orderListTable?.addEventListener('click', function (event) {
                if (event.target.classList.contains('rate-order-btn')) {
                    currentOrderIdToRate = event.target.dataset.orderId;
                    ratedOrderIdInput.value = currentOrderIdToRate;
                    selectedRating = 0;
                    resetStars();

                    const rateModalInstance = new bootstrap.Modal(document.getElementById('submitRating'));
                    if (rateModalInstance) {
                        rateModalInstance.hide();
                    }
                }
            });

            // Event listener for star rating selection
            starRatingContainer?.addEventListener('click', function (event) {
                if (event.target.classList.contains('star')) {
                    selectedRating = parseInt(event.target.dataset.rating);
                    highlightStars(selectedRating);
                }
            });

            // Event listener for submitting the rating
            submitRatingButton?.addEventListener('click', function () {
                const ratingDetails = ratingDetailsInput.value;

                if (currentOrderIdToRate && selectedRating > 0) {
                    const ratingData = {
                        rating: selectedRating,
                        details: ratingDetails,
                        timestamp: new Date().toISOString(),
                        studentId: auth.currentUser?.uid
                    };
                    console.log('Submitting rating for order ID:', currentOrderIdToRate, ratingData);
                    submitRatingToFirebase(currentOrderIdToRate, ratingData)
                        .then(() => {
                            alert('Rating submitted successfully!');
                            const rateModalInstance = bootstrap.Modal.getInstance(rateOrderModal);
                            rateModalInstance.hide();
                            window.location.reload();

                        })
                        .catch(error => {
                            console.error('Error submitting rating:', error);
                            alert('Failed to submit rating. Please try again.');
                        });
                } else {
                    alert('Please select a star rating before submitting.');
                }
            });

            function highlightStars(rating) {
                starRatingContainer?.querySelectorAll('.star').forEach(star => {
                    const starRating = parseInt(star.dataset.rating);
                    star.innerHTML = starRating <= rating ? '&#9733;' : '&#9734;';
                });
            }

            function resetStars() {
                starRatingContainer?.querySelectorAll('.star').forEach(star => {
                    star.innerHTML = '&#9734;';
                });
                ratingDetailsInput.value = ''; // Clear feedback on modal open
            }
        });

        async function submitRatingToFirebase(orderId, ratingData) {
            try {
                const ratingRef = ref(db, `Rating/${orderId}`);
                await set(ratingRef, {
                    rating: ratingData.rating,
                    comment: ratingData.details || null, // Use details as comment, handle optional
                    timestamp: ratingData.timestamp,
                    studentId: ratingData.studentId
                });
                console.log('Rating submitted successfully for order ID:', orderId);
            } catch (error) {
                console.error('Error submitting rating to Firebase:', error);
                throw error; // Re-throw the error to be caught by the calling function
            }
        }

        //start from here below is chat funtions

        let currentChatID = null;

        document.getElementById("messagesDropdownfirst").addEventListener("click", function () {
            const chatID = "chatID123"; // Replace with the correct chat ID logic
            OpenChat(chatID);
        });

        function OpenChat(chatID) {
            console.log("Chat Opened with ID:", chatID);
            currentChatID = chatID;

            const chatModal = document.getElementById("chatModal");
            if (chatModal) {
                chatModal.style.display = "block";
                loadMessages(chatID);
            } else {
                console.error("Chat modal not found!");
            }
        }



        window.CloseChat = function () {
            let chatModal = document.getElementById("chatModal");
            if (chatModal) {
                chatModal.style.display = "none"; // Hide modal
            }
        };


        function loadMessages(chatID) {
            if (!chatID) return;

            const chatRef = ref(db, "chats/" + chatID + "/messages"); //  Correct ref syntax

            onValue(chatRef, (snapshot) => {
                const messages = snapshot.val();
                displayMessages(messages); //  Call display function
            });
        }

        let currentUserRole = "student"; // or "assistant", depending on who is logged in

        function displayMessages(messages) {
            const chatBox = document.getElementById("chatBox");
            if (!chatBox) {
                console.error("Chat box not found!");
                return;
            }

            chatBox.innerHTML = ""; // Clear old messages to prevent duplicates

            if (messages) {
                //  Convert Firebase object to sorted array (by timestamp)
                const sortedMessages = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);

                sortedMessages.forEach(msg => {
                    const messageElement = document.createElement("p");

                    const isOwner = msg.sender === currentUserRole; // "student" or "assistant"
                    const bgColor = isOwner ? "bg-success" : "bg-primary"; // Green for own, Blue for received
                    const textAlign = isOwner ? "text-end" : "text-start"; // Align right for own, left for received

                    messageElement.className = `${textAlign} mb-2`;
                    messageElement.innerHTML = `<small class="${bgColor} p-3 text-white rounded-1 d-inline-block">${msg.text}</small>`;

                    chatBox.appendChild(messageElement); //  Append correctly
                });
            }

            chatBox.scrollTop = chatBox.scrollHeight; //  Auto-scroll to latest message
        };


        window.sendMessage = function () {
            let chatInput = document.getElementById("chatInput");
            let messageText = chatInput.value.trim();

            if (!messageText) return; // Prevent sending empty messages

            let newMessage = {
                sender: "student", // Modify this dynamically if needed
                text: messageText,
                timestamp: Date.now()
            };

            //  Push message to Firebase
            const chatRef = ref(db, "chats/" + currentChatID + "/messages");
            push(chatRef, newMessage)
                .then(() => {
                    console.log("Message sent to Firebase!");
                    chatInput.value = ""; // Clear input after sending
                })
                .catch((error) => {
                    console.error("Error sending message:", error);
                });
        };

        window.handleKeyPress = function (event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        };

        document.addEventListener("DOMContentLoaded", function () {
            let chatInput = document.getElementById("chatInput");
            if (chatInput) {
                chatInput.addEventListener("keypress", function (event) {
                    if (event.key === "Enter") {
                        sendMessage(); //  Calls sendMessage when Enter is pressed
                    }
                });
            } else {
                console.error("Error: chatInput field not found!");
            }
        });




    </script>
</body>

</html>