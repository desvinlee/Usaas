<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Admin View Order</title>
    <link rel="stylesheet" href="assets/css/css/sb-admin-2.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
</head>

<body id="page-top">
    <div id="wrapper">

        <!-- Sidebar copy from here-->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <hr class="sidebar-divider my-0">

            <div class="sidebar-heading">
                <img width="100" height="80" src="assets/img/Homepage/usaas_logo.svg" />
            </div>

            <li class="nav-item active">
                <a class="nav-link" href="Admin_Dashboard.html">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Admin Dashboard</span></a>
            </li>


            <hr class="sidebar-divider">


            <div class="sidebar-heading">
                Interface
            </div>


            <li class="nav-item">
                <a class="nav-link collapsed" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="true"
                    aria-controls="collapseTwo">
                    <i class="fas fa-fw fa-chart-area"></i>
                    <span>Order</span>
                </a>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Order:</h6>
                        <a class="collapse-item" href="Admin_ViewOrder.html">View Order</a>
                        <a class="collapse-item" href="Admin_Report.html">Report list</a>
                    </div>
                </div>
            </li>


            <li class="nav-item">
                <a class="nav-link collapsed" href="Admin_Viewdocument.html" data-target="#collapseUtilities"
                    aria-expanded="true" aria-controls="collapseUtilities">
                    <i class="fas fa-fw fa-table"></i>
                    <span>Document</span>
                </a>
            </li>

            <hr class="sidebar-divider">


            <div class="sidebar-heading">
                Settings
            </div>


            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                    aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-wrench "></i>
                    <span>Settings</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Profile: </h6>
                        <a class="collapse-item" href="Admin_Settings.html">Profile Settings</a>
                        <a class="collapse-item" href="Admin_Settings.html">Forgot Password</a>
                    </div>
                </div>
            </li>


            <li class="nav-item">
                <a class="nav-link" href="404.html">
                    <i class="fas fa-fw fa-cog"></i>
                    <span>Help & support</span></a>
            </li>


            <hr class="sidebar-divider d-none d-md-block">


            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>


        </ul>

        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav class="bg-white shadow navbar navbar-expand navbar-light topbar mb-4 static-top">
                    <div>
                        <button class="btn btn-link d-md-none rounded-circle mr-3" id="sidebarToggleTop"><i
                                class="fas fa-bars"></i></button>
                    </div>

                    <!--Search Bar-->
                    <form
                        class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
                        <div class="input-group"><input class="bg-light border-0 form-control form-control small"
                                type="text" aria-describedby="basic-addon2" aria-label="Search"
                                placeholder="Search for...">
                            <div class="input-group-text input-group-append"><button class="btn btn-primary"
                                    type="button"><i class="fas fa-search fa-sm"></i></button></div>
                        </div>
                    </form>

                    <ul class="navbar-nav ml-auto">

                        <li class="nav-item dropdown no-arrow mx-1">
                            <a class="nav-link dropdown-toggle" id="messagesDropdown" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <div class="sidebar-heading">Message </div>
                                <i class="fas fa-envelope fa-fw"></i>
                            </a>
                        </li>

                        <div class="topbar-divider d-none d-sm-block"></div>
                        <!--Edit username Here-->
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <img class="img-profile rounded-circle" src="assets/img/undraw_profile_2.svg">
                                <strong><span id="loggedUserFName"
                                        class="mr-2 d-none d-lg-inline text-gray-600 small"></span></strong>
                            </a>

                            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="userDropdown">
                                <a class="dropdown-item" id="logout" data-toggle="modal" data-target="#logoutModal">
                                    <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Logout
                                </a>
                            </div>
                        </li>
                    </ul>
                </nav>
                <div class="container-fluid">
                    <div class="d-sm-flex justify-content-between align-items-center mb-4">
                        <h1 class="h3 mb-0 text-gray-800">Order List</h1>
                        <a class="btn btn-primary btn-sm shadow-sm d-none d-sm-inline-block" role="button"
                            href="Admin_Report.html"><i class="fas fa-download text-white-50 fa-sm"></i> Generate
                            Report
                        </a>
                    </div>

                    <div class="row">
                        <div class="col">
                            <div class="card shadow mb-4">
                                <div class="card-body text-left">
                                    <div class="d-grid gap-3 d-md-flex justify-content-md-left">
                                        <button id="studentBtn" class="btn btn-primary">Student List</button>
                                        <button id="assistantBtn" class="btn btn-secondary">Assistant List</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Student Orders Section -->
                        <div id="studentOrderSection" class="order-section">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="text-primary m-0 font-weight-bold">Student Order</h6>
                                </div>
                                <div class="card-body">
                                    <table id="studentOrdersTable" class="table">
                                        <thead>
                                            <tr>
                                                <th>Order date</th>
                                                <th>Student</th>
                                                <th>Amount</th>
                                                <th>Assistant</th>
                                                <th>Approved</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminOrders"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>


                        <!-- Assistant Orders Section -->
                        <div id="assistantOrderSection" class="order-section" style="display:none;">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="text-primary m-0 font-weight-bold">Assistant Order</h6>
                                </div>
                                <div class="card-body">
                                    <table id="assistantOrdersTable" class="table">
                                        <thead>
                                            <tr>
                                                <th>Order date</th>
                                                <th>Assistant Details</th>
                                                <th>Rating</th>
                                                <th>Comment</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ratingsTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Modal for confirmation -->
                        <div class="modal fade" id="confirmationModal" tabindex="-1"
                            aria-labelledby="confirmationModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="confirmationModalLabel">Confirm Payment</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        Are you sure you want to release payment of <span id="confirmAmount"></span> to
                                        <span id="confirmAssistantName"></span>?
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary"
                                            id="confirmApproveButton">Confirm</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal -->
                        <!--
                        <div class="col">
                            <div class="row">
                                <div class="col-lg-6 col-xl-12 mb-4">
                                    <div class="card shadow mb-4">
                                        <div class="card-header py-3">
                                            <h6 class="text-primary m-0 font-weight-bold">International Student Document
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <table id="datatablesSimple">
                                                <thead>
                                                    <tr>
                                                        <th>Order date</th>
                                                        <th>Name</th>
                                                        <th>Status</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tfoot>
                                                    <tr>
                                                        <th>Order date</th>
                                                        <th>Name</th>
                                                        <th>Status</th>
                                                        <th></th>
                                                    </tr>
                                                </tfoot>

                                                <tbody>
                                                    <tr>
                                                        <td>2011/04/25</td>
                                                        <td>
                                                            <div>
                                                                <a class="nav-link collapsed" data-toggle="collapse"
                                                                    data-target="#collapseLayoutsorder"
                                                                    aria-expanded="true"
                                                                    aria-controls="collapseLayouts">Colleen Hurst</a>
                                                            </div>
                                                            <div id="collapseLayoutsorder" class="collapse"
                                                                aria-labelledby="headingOne">
                                                                <nav class="sb-sidenav-menu-nested nav">
                                                                    <h6 style="margin-top: 20px;">
                                                                        <span
                                                                            style="font-weight: normal !important;">Student
                                                                            card</span><br />
                                                                        <span
                                                                            style="font-weight: normal !important;">Driving
                                                                            license</span><br />
                                                                        <span
                                                                            style="font-weight: normal !important;">Car
                                                                            insurance</span>
                                                                    </h6>
                                                                </nav>
                                                            </div>
                                                        </td>

                                                        <td>Pending</td>
                                                        <td>
                                                            <div class="row">
                                                                <div class="col">
                                                                    <button class="btn btn-primary" type="button"
                                                                        style="background: #95e1d3;color: rgb(33,37,41);border-radius: 10px;border-color: var(--bs-table-striped-color);width: 100px;"
                                                                        data-bs-target="#confirmation"
                                                                        data-bs-toggle="modal">
                                                                        <strong>Approved</strong>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>

                                                        <td>2011/07/25</td>
                                                        <td>
                                                            <div>
                                                                <a class="nav-link collapsed" data-toggle="collapse"
                                                                    data-target="#collapseLayoutsorder1"
                                                                    aria-expanded="true"
                                                                    aria-controls="collapseLayouts">Garrett Winters</a>
                                                            </div>

                                                            <div>
                                                                <div id="collapseLayoutsorder1" class="collapse"
                                                                    aria-labelledby="headingOne">
                                                                    <nav class="sb-sidenav-menu-nested nav">
                                                                        <nav class="sb-sidenav-menu-nested nav">
                                                                            <h6
                                                                                style="margin-top: 20px;margin-left: 10px;">
                                                                                <span
                                                                                    style="font-weight: normal !important;">Student
                                                                                    card</span><br /><span
                                                                                    style="font-weight: normal !important;">Driving
                                                                                    license</span><br /><span
                                                                                    style="font-weight: normal !important;">Car
                                                                                    insurance</span></h6>
                                                                        </nav>
                                                                </div>
                                                        </td>
                                                        <td>Pending</td>
                                                        <td>
                                                            <div class="row">
                                                                <div class="col">
                                                                    <button class="btn btn-primary" type="button"
                                                                        style="background: #95e1d3;color: rgb(33,37,41);border-radius: 10px;border-color: var(--bs-table-striped-color);width: 100px;"
                                                                        data-bs-target="#confirmation"
                                                                        data-bs-toggle="modal">
                                                                        <strong>Approved</strong>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>

                                                    <tr>
                                                        <td>2009/01/12</td>
                                                        <td>
                                                            <div>
                                                                <a class="nav-link collapsed" data-toggle="collapse"
                                                                    data-target="#collapseLayoutsorder1"
                                                                    aria-expanded="true"
                                                                    aria-controls="collapseLayouts">Ashton Cox</a>
                                                            </div>

                                                            <div>
                                                                <div id="collapseLayoutsorder1" class="collapse"
                                                                    aria-labelledby="headingOne">
                                                                    <nav class="sb-sidenav-menu-nested nav">
                                                                        <nav class="sb-sidenav-menu-nested nav">
                                                                            <h6
                                                                                style="margin-top: 20px;margin-left: 10px;">
                                                                                <span
                                                                                    style="font-weight: normal !important;">Finland
                                                                                </span><br /><span
                                                                                    style="font-weight: normal !important;">Faculty
                                                                                    of Civil</span><br /><span
                                                                                    style="font-weight: normal !important;">Female</span>
                                                                            </h6>
                                                                        </nav>
                                                                </div>
                                                        </td>
                                                        <td>Pending</td>
                                                        <td>
                                                            <div class="row">
                                                                <div class="col">
                                                                    <button class="btn btn-primary" type="button"
                                                                        style="background: #95e1d3;color: rgb(33,37,41);border-radius: 10px;border-color: var(--bs-table-striped-color);width: 100px;"
                                                                        data-bs-target="#confirmation"
                                                                        data-bs-toggle="modal">
                                                                        <strong>Approved</strong>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>

                                                    <tr>
                                                        <td>2012/03/29</td>
                                                        <td>
                                                            <div>
                                                                <a class="nav-link collapsed" data-toggle="collapse"
                                                                    data-target="#collapseLayoutsorder1"
                                                                    aria-expanded="true"
                                                                    aria-controls="collapseLayouts">Cedric Kelly</a>
                                                            </div>

                                                            <div>
                                                                <div id="collapseLayoutsorder1" class="collapse"
                                                                    aria-labelledby="headingOne">
                                                                    <nav class="sb-sidenav-menu-nested nav">
                                                                        <nav class="sb-sidenav-menu-nested nav">
                                                                            <h6
                                                                                style="margin-top: 20px;margin-left: 10px;">
                                                                                <span
                                                                                    style="font-weight: normal !important;">Bangladash
                                                                                </span><br /><span
                                                                                    style="font-weight: normal !important;">Faculty
                                                                                    of Civil</span><br /><span
                                                                                    style="font-weight: normal !important;">Female</span>
                                                                            </h6>
                                                                        </nav>
                                                                </div>
                                                        </td>
                                                        <td>Pending</td>
                                                        <td>
                                                            <div class="row">
                                                                <div class="col">
                                                                    <button class="btn btn-primary" type="button"
                                                                        style="background: #95e1d3;color: rgb(33,37,41);border-radius: 10px;border-color: var(--bs-table-striped-color);width: 100px;"
                                                                        data-bs-target="#confirmation"
                                                                        data-bs-toggle="modal">
                                                                        <strong>Approved</strong>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>2012/12/02</td>
                                                        <td>
                                                            <div>
                                                                <a class="nav-link collapsed" data-toggle="collapse"
                                                                    data-target="#collapseLayoutsorder"
                                                                    aria-expanded="true"
                                                                    aria-controls="collapseLayouts">Brielle
                                                                    Williamson</a>
                                                            </div>

                                                            <div id="collapseLayoutsorder" class="collapse"
                                                                aria-labelledby="headingOne">
                                                                <nav class="sb-sidenav-menu-nested nav">
                                                                    <h6 style="margin-top: 20px;">
                                                                        <span
                                                                            style="font-weight: normal !important;">Indonesia</span><br />
                                                                        <span
                                                                            style="font-weight: normal !important;">Faculty
                                                                            of Science</span><br />
                                                                        <span
                                                                            style="font-weight: normal !important;">Male</span>
                                                                    </h6>
                                                                </nav>
                                                            </div>
                                                        </td>
                                                        <td>Pending</td>
                                                        <td>
                                                            <div class="row">
                                                                <div class="col">
                                                                    <button class="btn btn-primary" type="button"
                                                                        style="background: #95e1d3;color: rgb(33,37,41);border-radius: 10px;border-color: var(--bs-table-striped-color);width: 100px;"
                                                                        data-bs-target="#confirmation"
                                                                        data-bs-toggle="modal">
                                                                        <strong>Approved</strong>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> -->

                    </div>
                </div>
            </div>
            <footer class="bg-white sticky-footer">
                <div class="container-fluid px-4">
                    <div class="text-left my-auto copyright justify-content-between small">
                        <span style="font-family: Amiko, sans-serif;">Copyright © Desvin Lee 2024</span>
                    </div>
                </div>
            </footer>
        </div>
    </div><a class="scroll-to-top rounded" href="#page-top"><i class="fas fa-angle-up"></i></a>
    <div class="modal fade" role="dialog" tabindex="-1" id="logoutModal" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5><button aria-label="Close"
                        class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span></button>
                </div>
                <div class="modal-body"><span>Select "Logout" below if you are ready to end your current session.</span>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" data-dismiss="modal"
                        type="button">Cancel</button><a class="btn btn-primary" role="button"
                        href="login.html">Logout</a></div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/vendor/jquery/jquery.min.js"></script>
    <script src="assets/js/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="assets/js/js/sb-admin-2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js"></script>
    <script src="assets/js/js/Navigationbar.js"></script>

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getDatabase, ref, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAifkBmMPwQLTqRu8nYFU1dqej2dlX33Bk",
            authDomain: "usaas-4230f.firebaseapp.com",
            databaseURL: "https://usaas-4230f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "usaas-4230f",
            storageBucket: "usaas-4230f.firebasestorage.app",
            messagingSenderId: "1057123876526",
            appId: "1:1057123876526:web:fb4c3c0e6b2407295f773f",
            measurementId: "G-NSW66N1VGP"
        };


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);
        const firestore = getFirestore(app);

        window.addEventListener('DOMContentLoaded', event => {
            const datatablesSimple = document.getElementById('datatablesSimple');
            if (datatablesSimple) {
                new simpleDatatables.DataTable(datatablesSimple);
            }
        });

        let selectedOrder = null;
        let adminOrdersList = [];
        const studentTbody = document.getElementById('adminOrders');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const adminDocRef = doc(firestore, "admin", user.uid); // Changed collection name to "admin"
                const adminDocSnap = await getDoc(adminDocRef);

                if (adminDocSnap.exists()) {
                    LoadAdminOrders(); // Safe to call
                } else {
                    alert("Access denied: Only admin can view this panel.");
                    window.location.href = "/login.html"; // Or redirect elsewhere
                }
            } else {
                window.location.href = "/login.html";
            }
        });

        const LoadAdminOrders = () => {
            const dbRef = ref(db, 'StudentOrders');

            onValue(dbRef, (snapshot) => {
                adminOrdersList = [];
                snapshot.forEach((studentPhoneSnapshot) => {
                    const ordersForStudent = studentPhoneSnapshot.val();



                    if (ordersForStudent) {
                        Object.keys(ordersForStudent).forEach((orderId) => {
                            const order = ordersForStudent[orderId];
                            console.log("Loading order:", orderId, "under student:", studentPhoneSnapshot.key);

                            adminOrdersList.push({ id: orderId, phoneNumberOfStudent: studentPhoneSnapshot.key, ...order });
                        });
                    }
                });
                DisplayAdminOrders();

            }, (error) => {
                console.error("Error fetching admin orders:", error);
            });
        };

        const DisplayAdminOrders = () => {
            studentTbody.innerHTML = "";
            adminOrdersList.forEach(order => {
                AddSingleAdminOrder(order); // Now receives the individual order object
            });
        };

        const ApproveOrder = (orderId, phoneNumber) => {
            console.log("Trying to access path: StudentOrders/" + phoneNumber + "/" + orderId);

            const orderRef = ref(db, `StudentOrders/${phoneNumber}/${orderId}`);


            get(orderRef).then((snapshot) => {
                const orderData = snapshot.val();
                console.log("Order data received:", orderData);

                if (orderData && orderData.status === "Completed" && orderData.assistant && orderData.assistant.phone && orderData.price) {
                    const assistantPhoneNumber = orderData.assistant.phone;
                    const orderPrice = parseFloat(orderData.price); // Ensure price is a number

                    const WalletRef = ref(db, `StudentWallet/${assistantPhoneNumber}`);

                    get(WalletRef).then((walletSnapshot) => {
                        const currentBalance = walletSnapshot.val()?.balance || 0;
                        const newBalance = currentBalance + orderPrice;

                        update(WalletRef, { balance: newBalance })
                            .then(() => {
                                console.log(`Payment of RM ${orderPrice.toFixed(2)} released to assistant ${assistantPhoneNumber}. New balance: RM ${newBalance.toFixed(2)}`);
                                alert(`Payment of RM ${orderPrice.toFixed(2)} released to assistant.`);
                                // Optionally update the order status to "Payment Released"
                                update(orderRef, { status: "Payment Released" });
                            })
                            .catch((error) => {
                                console.error("Error updating assistant wallet:", error);
                                alert("Error releasing payment to assistant.");
                            });

                    }).catch((error) => {
                        console.error("Error fetching assistant wallet:", error);
                        alert("Could not fetch assistant's wallet information.");
                    });
                } else {
                    alert("Order cannot be approved for payment release.");
                    console.warn("Order not eligible for payment release:", orderData);
                }
            }).catch((error) => {
                console.error("Error fetching order details:", error);
                alert("Could not fetch order details.");
            });
        };

        const AddSingleAdminOrder = (order) => {


            // Expecting an individual order object
            let trow = document.createElement('tr');
            let td1 = document.createElement('td'); // Time
            let td2 = document.createElement('td'); // Name + Faculty + Phone + Price
            let td3 = document.createElement('td'); // Status
            let td4 = document.createElement('td'); // Assistant Name + Phone
            let td5 = document.createElement('td'); // Action Button

            td1.style.textAlign = 'left';
            td2.style.textAlign = 'left';
            td3.style.textAlign = 'left';
            td4.style.textAlign = 'left';
            td5.style.textAlign = 'left';

            td1.innerHTML = order.orderTime || "Unknown";

            td2.innerHTML = `${order.nameofstudent?.firstname || "Unknown"} ${order.nameofstudent?.lastname || "Unknown"}
        <br>${order.faculty?.facultyname || "Unknown"}
        <br>RM ${order.price || "Unknown"}
        <br><strong>${order.phone || "No Phone"}</strong>`; // Use order.phone

            let statusColor;
            if (order.status === "Accepted") {
                statusColor = "#0ee535"; // Green
            } else if (order.status === "Completed") {
                statusColor = "#95E1D3"; // Light Blue/Green
            } else if (order.status === "Pending") {
                statusColor = "#fce38a"; // Yellow
            } else {
                statusColor = "#000000"; // Default color (Black) for any other status
            }

            td3.innerHTML = `<i class="far fa-stop-circle" style="color: ${statusColor}; vertical-align: middle;">
                    </i> ${order.status || "Pending"}`;

            td4.innerHTML = order.assistant
                ? `${order.assistant.name} <br> ${order.assistant.phone}`
                : "Not Assigned";

            td5.innerHTML = ""; // Clear previous buttons

            if (order.status === "Completed") {
                let approveButton = document.createElement('button');
                approveButton.className = "btn btn-success";
                approveButton.type = "button";
                approveButton.style = "border-radius: 6px; background: #28a745; color: white;";
                approveButton.innerHTML = "Approve Payment";
                approveButton.onclick = () => ApproveOrder(order.id, order.phoneNumberOfStudent);
                td5.appendChild(approveButton);
            }

            trow.append(td1, td2, td3, td4, td5);
            studentTbody.appendChild(trow);
        };


        let ratingOrdersList = [];
        const tbody = document.getElementById('ratingsTableBody');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const adminDocRef = doc(firestore, "admin", user.uid);
                const adminDocSnap = await getDoc(adminDocRef);

                if (adminDocSnap.exists()) {
                    LoadRatingOrders(); // Call the function to load rating data
                } else {
                    alert("Access denied: Only admin can view this panel.");
                    window.location.href = "/login.html";
                }
            } else {
                window.location.href = "/login.html";
            }
        });

        const LoadRatingOrders = () => {
            const ratingsRef = ref(rtdb, 'Rating');

            onValue(ratingsRef, (snapshot) => {
                ratingOrdersList = [];
                const ratingsData = snapshot.val();

                if (ratingsData) {
                    Object.keys(ratingsData).forEach((orderId) => {
                        const rating = ratingsData[orderId];
                        // For each rating, we need to fetch the corresponding order details
                        fetchOrderDetails(orderId)
                            .then(order => {
                                if (order) {
                                    ratingOrdersList.push({
                                        id: orderId,
                                        ...order, // Include order details
                                        rating: rating.rating,
                                        comment: rating.comment
                                    });
                                } else {
                                    console.log(`Order details not found for rating with ID: ${orderId}`);
                                    ratingOrdersList.push({ id: orderId, rating: rating.rating, comment: rating.comment, orderTime: 'N/A', assistant: { name: 'N/A', phone: 'N/A' } }); // Still display rating even if order is missing
                                }
                                DisplayRatingOrders(); // Call after processing each rating (can be inefficient for many ratings)
                            })
                            .catch(error => {
                                console.error("Error fetching order details for rating ID:", orderId, error);
                                ratingOrdersList.push({ id: orderId, rating: rating.rating, comment: rating.comment, orderTime: 'Error', assistant: { name: 'Error', phone: 'Error' } }); // Display error info
                                DisplayRatingOrders(); // Call after processing each rating (can be inefficient)
                            });
                    });
                } else {
                    DisplayRatingOrders(); // Display empty table
                }
            }, (error) => {
                console.error("Error fetching ratings:", error);
            });
        };

        const DisplayRatingOrders = () => {
            tbody.innerHTML = "";
            ratingOrdersList.forEach(orderWithRating => {
                AddSingleRatingOrder(orderWithRating);
            });
        };

        const AddSingleRatingOrder = (orderWithRating) => {
            let trow = document.createElement('tr');
            let td1 = document.createElement('td'); // Time
            let td2 = document.createElement('td'); // Assistant Name + Phone
            let td3 = document.createElement('td'); // Rating
            let td4 = document.createElement('td'); // Comment

            td1.style.textAlign = 'left';
            td2.style.textAlign = 'left';
            td3.style.textAlign = 'left';
            td4.style.textAlign = 'left';

            td1.innerHTML = orderWithRating.orderTime || "Unknown";

            td2.innerHTML = orderWithRating.assistant
                ? `${orderWithRating.assistant.name} <br> ${orderWithRating.assistant.phone}`
                : "Not Assigned";

            td3.innerHTML = `${orderWithRating.rating || "N/A"} <i class="fas fa-star"></i> `;

            td4.innerHTML = orderWithRating.comment || "No comment";

            trow.append(td1, td2, td3, td4);
            tbody.appendChild(trow);
        };

        async function fetchOrderDetails(orderId) {
            const studentOrdersRef = ref(rtdb, 'StudentOrders');
            const snapshot = await get(studentOrdersRef);
            if (snapshot.exists()) {
                let foundOrder = null;
                snapshot.forEach(studentPhoneSnapshot => {
                    const orders = studentPhoneSnapshot.val();
                    if (orders && orders[orderId]) {
                        foundOrder = orders[orderId];
                        return true;
                    }
                });
                return foundOrder;
            }
            return null;
        }


        document.getElementById("studentBtn").addEventListener("click", () => {
            document.getElementById("studentOrderSection").style.display = "block";
            document.getElementById("assistantOrderSection").style.display = "none";

            DisplayAdminOrders(); // Loads student orders
        });

        document.getElementById("assistantBtn").addEventListener("click", () => {
            document.getElementById("studentOrderSection").style.display = "none";
            document.getElementById("assistantOrderSection").style.display = "block";

            DisplayRatingOrders(); // Loads assistant-related data
        });


    </script>
</body>

</html>